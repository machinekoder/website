<!--
{
  "title": "Machinekit and Cura",
  "date": "2016-08-17T22:14:42",
  "slug": "machinekit-and-cura",
  "original_url": "https://machinekoder.com/machinekit-and-cura/",
  "featured_image": "/static/blog_images/machinekit-and-cura/cura_machinekit.png"
}
-->
<span class="rt-reading-time" style="display: block;"><span class="rt-label rt-prefix"></span> <span class="rt-time">4</span> <span class="rt-label rt-postfix">minutes read<br/></span></span><h2>Slicing and Cura</h2>
<p>The process of creating program code (<em>GCode</em>), which are used as input for 3D printers, from 3D object files (<em>STL</em>) is called slicing, because the object is basically sliced into many very thin layers.</p>
<p><a href="https://ultimaker.com/en/products/cura-software">Cura</a> is an open source slicing software supported by Ultimaker for their 3d printers. Besides the official version from Ultimaker, many other 3d printer manufacturers support Cura as slicing software. The lasted version of Cura is based on Python and Qt5/QML, which makes it a perfect match for integration with <a href="http://machinekit.io">Machinekit</a> and <a href="https://github.com/machinekoder/QtQuickVcp">QtQuickVcp</a>. Throughout this article, I use Cura version <code>2.3.1</code>.</p>
[Update on Jan 22nd 2017]: Updated the blog post for Cura 2.3.1
<h2>What I used before</h2>
<p>Until recently I have used Slic3r as my main CAM/slicing software for 3d printing. This required a <a href="https://github.com/machinekoder/Slic3r/tree/velocity-extrusion">few modifications</a> to the <a href="http://slic3r.org/">Slic3r</a> source code, since Machinekit uses <a href="http://www.machinekit.io/docs/gcode/overview/">RS274-NGC flavor GCode</a> compared to <a href="http://reprap.org/wiki/G-code">RepRap/Marling flavor GCode</a> used by most 3d printers. This is especially important since I use Machinekit with <a href="http://basdebruijn.com/tag/velocity-extrusion/">velocity extrusion</a> support. However, since the modifications to Slic3r are <a href="https://github.com/alexrj/Slic3r/pull/2743">not going to be merged upstream</a>, I started to look for a suitable alternative.</p>
<h2>Adding a new GCode flavor to Cura</h2>
<p>It turned out that it is not very hard to add support for new GCode flavors to Cura using <a href="https://github.com/Ultimaker/Cura/tree/master/plugins/GCodeWriter">plugins</a>, written in Python. To add a new plugin it is best to start off by forking an existing Cura plugin, in my case the <em>X3GWriter</em> plugin. The resulting NGCWriter plugin can be found on <a href="https://github.com/machinekoder/NGCWriter">Github</a>.</p>
<p>Let's take a look at the <code>__init__.py</code> file of the plugin:</p>
<pre><code class="python">from . import NGCWriter

from UM.i18n import i18nCatalog
catalog = i18nCatalog("cura")


def getMetaData():
    return {
        "plugin": {
            "name": catalog.i18nc("@label", "NGC Writer"),
            "author": "Machine Koder",
            "version": "1.0",
            "description": catalog.i18nc("NGC Writer Plugin Description", "Writes RS-274 GCode to a file"),
            "api": 3
        },

        "mesh_writer": {
            "output": [{
                "extension": "ngc",
                "description": catalog.i18nc("@item:inlistbox", "RS-274 GCode File"),
                "mime_type": "text/x-ngc",
                "mode": NGCWriter.NGCWriter.OutputMode.TextMode
            }]
        }
    }


def register(app):
    return {"mesh_writer": NGCWriter.NGCWriter()}
</code></pre>
<p>We see that the plugin registers as <code>"mesh_writer"</code> which allows us to post-process the GCode generated by Cura. The MIME type <code>text/x-ngc</code> tells Cura to use this output plugin whenever a <code>.ngc</code> file needs to be generated.</p>
<p>In the <code>NGCWriter.py</code> module a class inheriting from <code>MeshWriter</code> is used:</p>
<pre><code class="python">class NGCWriter(MeshWriter):
    version = 3

    def __init__(self):
        super().__init__()

    def write(self, stream, node, mode=MeshWriter.OutputMode.TextMode):
        if mode != MeshWriter.OutputMode.TextMode:
            Logger.log("e", "NGC Writer does not support non-text mode.")
            return False

        #Get the g-code.
        scene = Application.getInstance().getController().getScene()
        gcode_list = getattr(scene, "gcode_list")
        if gcode_list:
            gcodeConverter = GCode2Ngc()
            veConverter = Ngc2Ve()
            gcodeConverter.process(gcode_list)
            veConverter.process(gcode_list)

            for gcode in gcode_list:
                stream.write(gcode)

            return True

        return False
</code></pre>
<p>The RepRap flavor GCode can be accessed layer by layer (not line by line) as a list. This list is then passed to our to post processors. <code>GCode2Ngc</code> converts the RepRap flavor GCode to Machinekit compatible RS274-NGC GCode. The second post-processor <code>Ngc2Ve</code> applies modifications for velocity extrusion support. I will not go into details about the post processors in this post. However, feel free to check out the source code on <a href="https://github.com/machinekoder/NGCWriter">Github</a></p>
<p>To install the plugin, we just need to copy the complete folder (which is a Python module) to <code>/lib/cura/plugins/</code>. The plugin loads automatically at the next start of Cura.</p>
<h2>Adding a new 3D printer to Cura</h2>
<p>To use the newly created output plugin, we have to add a new 3D printer configuration to Cura. Again it is easiest to start off with an existing configuration which can be found in <code>/share/cura/resources/definitions/</code>.</p>
<p>Here is the configuration I created for the UNI-PRINT-3D machine:</p>
<pre><code class="json">{
    "id": "uni_print_3d",
    "name": "UNI-PRINT-3D",
    "version": 2,
    "inherits": "fdmprinter",
    "metadata":
    {
        "visible": true,
        "author": "Alexander RÃ¶ssler",
        "category": "TheCoolTool",
        "manufacturer": "TheCoolTool",
        "file_formats": "text/x-ngc;text/x-gcode",
        "platform": "uni_print_3d_platform.stl",
        "platform_offset": [0, 0, 0]
    },

    "overrides": {
        "machine_name": { "default_value": "UNI-PRINT-3D" },
        "machine_heated_bed": { "default_value": true },
        "machine_width": { "default_value": 186 },
        "machine_height": { "default_value": 230 },
        "machine_depth": { "default_value": 220 },
        "machine_center_is_zero": { "default_value": true },
        "machine_nozzle_size": { "default_value": 0.4 },
        "material_diameter": { "default_value": 1.75 },
        "machine_nozzle_heat_up_speed": { "default_value": 2.0 },
        "machine_nozzle_cool_down_speed": { "default_value": 2.0 },
        "machine_head_shape_min_x": { "default_value": 75 },
        "machine_head_shape_min_y": { "default_value": 18 },
        "machine_head_shape_max_x": { "default_value": 18 },
        "machine_head_shape_max_y": { "default_value": 35 },
        "machine_nozzle_gantry_distance": { "default_value": 55 },
        "machine_gcode_flavor": { "default_value": "RepRap (Marlin/Sprinter)" },

        "machine_start_gcode": {
            "default_value": "M53; enable feed-hold\nG0 Z2.0; always start from the same height to compensate backlash\nG28; move extruder to 0\nM420 R0.0 E0.0 D0.0 P0.1 ; turn the lights on\nM107; turn off fan\nG64 P0.05 Q0.05; path blending settings\nG23; unretract"
        },
        "machine_end_gcode": {
            "default_value": "M104 P0 ; turn off hotend\nG0 X-80 Y100; move the extruder out of the way\nM420 R0.0 E0.1 D0.0 P0.6 ; signalize end of print\nM140 P0 ; turn off heatbed\nM65 P16 ; turn off external fan\nM65 P15 ; turn off power"
        }
    }
}
</code></pre>
<p>Most of the values in the JSON file should be straightforward if you are familiar with 3D printing. The most important line to mention is <code>"file_formats": "text/x-ngc;text/x-gcode",</code> which enables the use of the <code>NGCWriter</code> plugin.</p>
<p>To add a new 3d printer platform to Cura (see <code>"platform": "uni_print_3d_platform.stl",</code>) we have to add a new mesh aka. STL file to <code>/share/cura/resources/meshes/</code>. To model a new platform my 3d printer I used the CAD software <a href="http://www.openscad.org/">OpenSCAD</a>. Basically I created a simple cube with the size of my build platform:</p>
<pre><code class="openscad">w = 190;
d = 280;
th = 5;

translate([-w/2,-d/2,-th]) cube([w,d,th]);
</code></pre>
<p>After rendering the cube (F6) we can export the STL file from the menu of the OpenSCAD GUI. The newly generated STL file needs to be placed in <code>/share/cura/resources/meshes/</code> and we are all set.</p>
<p><img alt="Marvin_Cura" class="alignnone wp-image-25" decoding="async" height="363" loading="lazy" sizes="(max-width: 644px) 100vw, 644px" src="/static/blog_images/machinekit-and-cura/Marvin_Cura-300x169.png" srcset="https://machinekoder.com/wp-content/uploads/2016/08/Marvin_Cura-300x169.png 300w, https://machinekoder.com/wp-content/uploads/2016/08/Marvin_Cura-768x432.png 768w, https://machinekoder.com/wp-content/uploads/2016/08/Marvin_Cura-1024x576.png 1024w" width="644"/></p>
<h2>Wrapping up</h2>
<p>The complete code of the Cura plugin and 3d printer configuration can be found on Github: <a href="https://github.com/machinekoder/uni-print-3d-cura">machinekoder/uni-print-3d-cura</a>. I have already used Cura for several successful prints. So far, I am very satisfied with the slicing quality. Compared to Slic3r I noticed that the Cura generated GCode is more consistent when it comes to the diameter of the extruded material, which in theory, should result in better printing quality.</p>
<p><a href="https://machinekoder.com/wp-content/uploads/2016/08/20160806_008.jpg"><img alt="20160806_008" class="alignnone wp-image-23" decoding="async" height="319" loading="lazy" sizes="(max-width: 566px) 100vw, 566px" src="/static/blog_images/machinekit-and-cura/20160806_008-300x169.jpg" srcset="https://machinekoder.com/wp-content/uploads/2016/08/20160806_008-300x169.jpg 300w, https://machinekoder.com/wp-content/uploads/2016/08/20160806_008-768x433.jpg 768w, https://machinekoder.com/wp-content/uploads/2016/08/20160806_008-1024x577.jpg 1024w" width="566"/></a></p>
<p>I hope the provided information is useful. More posts about 3D printing will follow soon, so please stay tuned and subscribe. Any feedback is welcome.</p>
<p>If you want to learn more about 3D printing, check out the <a href="https://tactilehobby.com/beginners-guide-to-3d-printing/">Begginers Guide to 3D Printing.</a></p>
